---
title: "PM 566 Midterm Project"
author: "Brandyn Ruiz"
date: "10/5/2020"
output: html_document
---

```{r, message=FALSE, echo=TRUE, warning=FALSE}
library(readr)
library(dplyr)
library(data.table)
library(httr)
library(rjson)
```

```{r Covid Github, message=FALSE, warning=FALSE}
download.file("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv", "time_series_covid19_confirmed_US.csv", method="libcurl", timeout = 60)

covidGithub <- data.table::fread("time_series_covid19_confirmed_US.csv")

# Applying filter to only select covid confirmed cases in California
covidGithub <- covidGithub%>%
  filter(Province_State == 'California')
```

```{r}
# Table listing all counties within California
df <- unique(covidGithub$Admin2)
knitr::kable(df, col.names = 'County')

covidGithub <- covidGithub[ !(covidGithub$Admin2 %in% c('Unassigned', 'Out of CA')), ]
```

We see that some of the counties do not make sense such as 'Unassigned' and 'Out of CA'. Therefore, we can remove these reported counties.

```{r, message=FALSE}
# Daily AQI for every county in California
csvAQI_data <- read_csv("ad_viz_plotval_data.csv")

csvAQI_data$Date <- as.Date(csvAQI_data$Date, format = "%m/%d/%Y")

# Test to see if counties have current dates
csvAQI_data%>%
  group_by(COUNTY)%>%
  summarise(MinDate = min(Date), MaxDate = max(Date))%>%
  knitr::kable()
```

For some of our counties within the AQI dataset, they do not have the current end date of 10/06/2020. For some of them the counties have records that end during the middle and begining of the year, this could be due to many factors being underfunded or unmanned because of the coronavirus, burned out by the fires, or other natural causes for example. We also observe that some counties are not even reported for AQI and could be that they do not have a recording site within that county. For further analysis counties that do not have AQI recorded will be dropped in the comparision of covid confirmed cases in each county.

```{r, warning=FALSE}
covidCounty <- unique(covidGithub$Admin2)
aqiCounty <- unique(csvAQI_data$COUNTY)

binary <- covidCounty %in% aqiCounty
matched <- intersect(covidCounty, aqiCounty)

df <- cbind(covidCounty, aqiCounty, binary)
knitr::kable(df, col.names = c('covidCounty', 'aqiCounty', 'Binary'))
knitr::kable(matched, col.names = 'Matched Counties')
```

We will be using these 51 counties from our matched table, so that both data sets have records from the same county.

```{r Melting covid data set}
# Keeping the same matched couties in covid data set
covidGithub <- covidGithub[covidGithub$Admin2 %in% matched, ]

# Attempt to melt covid to long format
covidGithubmelt <- melt(covidGithub, id = 1:11, variable.name = 'Date', variable.factor = FALSE,
                        value.name = 'Confirmed')
covidGithubmelt$Date <- as.Date(covidGithubmelt$Date, format = "%m/%d/%y")

# Current covid dates for each county
covidGithubmelt%>%
  group_by(Admin2)%>%
  summarise(MinDate = min(Date), MaxDate = max(Date))%>%
  knitr::kable()
```

```{r Merge of covid and AQI}
# Renaming county code in AQI to FIPS to match with covid data set
csvAQI_data <- csvAQI_data%>%
  rename(FIPS = COUNTY_CODE, PM2.5 = `Daily Mean PM2.5 Concentration`)

csvAQI_data$FIPS <- paste0(6, csvAQI_data$FIPS)
csvAQI_data$FIPS <- as.numeric(csvAQI_data$FIPS)

csvAQI_data <- csvAQI_data[, c('Date', 'PM2.5', 'DAILY_AQI_VALUE', 'STATE', 'FIPS', 'COUNTY')]

# Renaming key variables in covid data set to merge with AQI
covidGithubmelt <- covidGithubmelt%>%
  rename(COUNTY = Admin2, STATE = Province_State, SITE_LATITUDE = Lat, SITE_LONGITUDE = Long_)

# To include geolocation of covid recording site
covidGithubmelt <- covidGithubmelt[, c('Date', 'FIPS', 'COUNTY', 'STATE',
                                       "SITE_LATITUDE", "SITE_LONGITUDE", 'Confirmed')]

# Full outer join
mergeFullOut <- merge(csvAQI_data, covidGithubmelt, all = TRUE)

# Deletes missing values for the first records of covid data in California appeared in 1/22/2020
mergeFullOut <- na.omit(mergeFullOut)
```


