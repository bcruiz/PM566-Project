---
title: "PM 566 Midterm Project"
author: "Brandyn Ruiz"
date: "10/5/2020"
output: html_document
---

```{r, message=FALSE, echo=TRUE, warning=FALSE}
library(readr)
library(dplyr)
library(data.table)
library(httr)
library(rjson)
library(ggplot2)
library(usmap)
library(RColorBrewer)
library(rgdal)
library(ggrepel)
```

## Introduction

## Methods

```{r Covid Github, message=FALSE, warning=FALSE}
download.file("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv", "time_series_covid19_confirmed_US.csv", method="libcurl", timeout = 60)

covidGithub <- data.table::fread("time_series_covid19_confirmed_US.csv")

# Applying filter to only select covid confirmed cases in California
covidGithub <- covidGithub%>%
  filter(Province_State == 'California')
```

```{r Covid Filter County}
# Table listing all counties within California
df <- unique(covidGithub$Admin2)
knitr::kable(df, col.names = 'County')

covidGithub <- covidGithub[ !(covidGithub$Admin2 %in% c('Unassigned', 'Out of CA')), ]
```

```{r Melting Covid Data Set, message = FALSE, warning = FALSE}
# Attempt to melt covid to long format
covidGithubmelt <- melt(covidGithub, id = 1:11, variable.name = 'Date', variable.factor = FALSE,
                        value.name = 'Confirmed')
covidGithubmelt$Date <- as.Date(covidGithubmelt$Date, format = "%m/%d/%y")

# Current covid dates for each county
covidGithubmelt%>%
  group_by(Admin2)%>%
  summarise(MinDate = min(Date), MaxDate = max(Date))%>%
  knitr::kable()

# Group by counties and order by date
covidGithubmelt <- covidGithubmelt%>%
  group_by(Admin2)%>%
  arrange(Date, .by_group = TRUE)
```

```{r New Cases Varible}
#Needs Fixing
# Add variables for new_cases:
for (i in 1:length(covidGithubmelt)) {
  cvd_subset = subset(cv_states, state == state_list[i])
  cv_subset = cv_subset[order(cv_subset$date),]

  # add starting level for new cases and deaths
  cv_subset$new_cases = cv_subset$cases[1]
  cv_subset$new_deaths = cv_subset$deaths[1]

  #### FINISH THE CODE HERE ###
  for (j in 2:nrow(cv_subset)) {
    cv_subset$new_cases[j] =  cv_subset$cases[j] - cv_subset$cases[j-1] 
    cv_subset$new_deaths[j] = cv_subset$deaths[j] - cv_subset$deaths[j-1]
  }

  # include in main dataset
  cv_states$new_cases[cv_states$state==state_list[i]] = cv_subset$new_cases
  cv_states$new_deaths[cv_states$state==state_list[i]] = cv_subset$new_deaths
}
```


```{r, message=FALSE}
# Daily AQI for every county in California
csvAQI_data <- read_csv("data/ad_viz_plotval_data.csv")

csvAQI_data$Date <- as.Date(csvAQI_data$Date, format = "%m/%d/%Y")

# Test to see if counties have current dates
csvAQI_data%>%
  group_by(COUNTY)%>%
  summarise(MinDate = min(Date), MaxDate = max(Date))%>%
  knitr::kable()
```

```{r, warning=FALSE}
covidCounty <- unique(covidGithub$Admin2)
aqiCounty <- unique(csvAQI_data$COUNTY)

binary <- covidCounty %in% aqiCounty
matched <- intersect(covidCounty, aqiCounty)

df <- cbind(covidCounty, aqiCounty, binary)
knitr::kable(df, col.names = c('covidCounty', 'aqiCounty', 'Binary'))
knitr::kable(matched, col.names = 'Matched Counties')
```

### AQI Exploration

```{r}
# Renaming county code in AQI to FIPS to match with covid data set
csvAQI_data <- csvAQI_data%>%
  rename(FIPS = COUNTY_CODE, PM2.5 = `Daily Mean PM2.5 Concentration`)

csvAQI_data$FIPS <- paste0(6, csvAQI_data$FIPS)
csvAQI_data$FIPS <- as.numeric(csvAQI_data$FIPS)

csvAQI_data <- csvAQI_data[, c('Date', 'PM2.5', 'DAILY_AQI_VALUE', 'STATE', 'FIPS', 'COUNTY')]

# Renaming key variables in covid data set to merge with AQI
covidGithubmelt <- covidGithubmelt%>%
  rename(COUNTY = Admin2, STATE = Province_State, SITE_LATITUDE = Lat, SITE_LONGITUDE = Long_)

# To include geolocation of covid recording site
covidGithubmelt <- covidGithubmelt[, c('Date', 'FIPS', 'COUNTY', 'STATE',
                                       "SITE_LATITUDE", "SITE_LONGITUDE", 'Confirmed')]
```

```{r, message = FALSE, warning = FALSE}
# Visual map of California by county
plot_usmap("counties", include = 'CA', labels = TRUE, label_color = "blue", fill = "yellow", alpha = 0.25,
           color = "orange", size = 1)+
  labs(title = 'County Map of California')

# Adjusting Merge data set to ggmap setting with only FIPS and Confirmed variables 
mapdf <- covidGithubmelt%>%
  filter(Date == '2020-10-06')%>%
  select(FIPS, Confirmed)%>%
  distinct()%>%
  rename(fips = FIPS)

plot_usmap(data = mapdf, values='Confirmed', include = 'CA')+
  scale_fill_distiller(type = "seq", palette = "Spectral", direction = -1, name = "Confirmed Cases")+
  labs(title = 'Total Confirmed Cases in California by County',
       subtitle = 'Source: Johns Hopkins University Center for Systems Science and Engineering (JHU CSSE)',
       caption = 'Up until 10/06/2020')+
  theme(plot.title = element_text(hjust = 0.5, vjust = 0.25, size = 18), legend.position = "right",
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))
```

### Covid confirmed cases by county

```{r Merge of covid and AQI}
# Keeping the same matched couties in covid data set
covidGithubmelt <- covidGithubmelt[covidGithubmelt$COUNTY %in% matched, ]

# Full outer join
mergeFullOut <- merge(csvAQI_data, covidGithubmelt, all = TRUE)

# Deletes missing values for the first records of covid data in California appeared in 1/22/2020
mergeFullOut <- na.omit(mergeFullOut)
```

### Merge of Covid and AQI data sets

```{r EDA Merge}
# Could be in outout, but alos just mentioned of the extreme values for AQI and PM 2.5
mergeFullOut%>%
  group_by(COUNTY)%>%
  summarise(MinPM2.5 = min(PM2.5), MaxPM2.5 = max(PM2.5), MinAQI = min(DAILY_AQI_VALUE),
            MaxAQI = max(DAILY_AQI_VALUE))%>%
  knitr::kable()
```

### Summary of Merged data set

```{r}
# Line plot of daily covid cases in Los Angeles county
ggplot(mergeFullOut%>%
         filter(COUNTY == 'Los Angeles'), aes(x = Date, y = Confirmed))+
  geom_line()+
  labs(title = 'Daily covid cases in Los Angeles County', y = 'Confirmed Cases of Covid')

```

```{r}
# Line plot of daily AQI in Los Angeles county
ggplot(mergeFullOut%>%
         filter(COUNTY == 'Los Angeles'), aes(x = Date, y = DAILY_AQI_VALUE))+
  geom_line()+
  labs(title = 'Daily AQI in Los Angeles County', y = 'AQI')
```

### Visual Exploration

```{r Association test}
# Linear Regression to test the association between Confirmed covid cases and daily AQI
lm(Confirmed ~ DAILY_AQI_VALUE, data = mergeFullOut)%>%
  summary()
```

## Conclusion
